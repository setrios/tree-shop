{% extends "base.html" %}

{% block content %}
{% csrf_token %}

<main class="bg-white p-6 md:p-8 border border-gray-200">
    <div class="flex justify-between items-end border-b-2 border-black pb-4 mb-8">
        <h2 class="text-3xl font-bold uppercase tracking-tight">Your Cart</h2>
        <h3 class="text-xl">Total: <span class="font-bold text-secondary">$<span id="cart-total">{{ cart_total }}</span></span></h3>
    </div>
    
    <div class="space-y-6">
        {% for cart_item in cart_items %}
            <div class="card flex flex-col md:flex-row gap-6 items-center bg-gray-50 p-4 border border-gray-100" data-product-id="{{ cart_item.product.id }}">
                
                <a href="{% url 'products:tree_detail' cart_item.product.id %}" class="flex items-center gap-6 flex-grow w-full md:w-auto">
                    <img src="{{ cart_item.product.image.url }}" alt="{{ cart_item.product.name }}" class="w-24 h-24 object-cover border border-gray-200">
                    <div>
                        <h4 class="text-lg font-bold">{{ cart_item.product.name }}</h4>
                        <p class="text-sm text-gray-500">{{ cart_item.product.tree_type }} / {{ cart_item.product.color }}</p>
                        <p class="text-sm font-medium mt-1">${{ cart_item.product.price }}</p>
                    </div>
                </a>
                
                <div class="cart-controls flex flex-col md:flex-row items-center gap-6 w-full md:w-auto justify-between">
                    <div class="flex items-center border border-dark bg-white">
                        <button class="decrease-cart px-3 py-1 hover:bg-gray-100 font-bold" data-product-id="{{ cart_item.product.id }}">-</button>
                        <span class="quantity-display px-3 font-mono">{{ cart_item.quantity }}</span>
                        <button class="increase-cart px-3 py-1 hover:bg-gray-100 font-bold" data-product-id="{{ cart_item.product.id }}" data-max-stock="{{ cart_item.product.quantity }}">+</button>
                    </div>
                    
                    <div class="text-right min-w-[100px]">
                        <h5 class="font-bold text-lg">$<span class="item-total">{{ cart_item.total_price }}</span></h5>
                    </div>

                    <button class="remove-cart text-red-500 text-sm font-bold hover:text-red-700 uppercase tracking-wider border-b border-transparent hover:border-red-700" data-product-id="{{ cart_item.product.id }}">
                        Remove
                    </button>
                </div>
            </div>
        {% empty %}
            <div class="text-center py-12 bg-gray-50">
                <p class="text-xl text-gray-400">Your cart is empty</p>
            </div>
        {% endfor %}
    </div>

    {% if cart_items %}
        <div class="mt-8 flex justify-end">
            <form action="{% url 'orders:place_order' %}" method="post" class="w-full md:w-auto">
                {% csrf_token %}
                <button type="submit" class="w-full md:w-auto bg-primary text-dark font-bold px-12 py-4 text-lg hover:bg-secondary hover:text-white transition-colors duration-200 uppercase tracking-widest">
                    Checkout
                </button>
            </form>
        </div>
    {% endif %}
</main>

<script type="text/javascript">
    // (Keep your existing JS logic exactly as is, it's functional)
    // ... [Insert the JS from your original file here] ...
    // Just ensure to keep the getCookie and updateCart functions
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');
    
    // ... [Rest of your JS] ...
    // Just copying the key functionality for brevity in this response:
    function updateCart(url, productId, quantity = null) {
        const formData = new FormData();
        formData.append('product_id', productId);
        formData.append('csrfmiddlewaretoken', csrftoken);
        formData.append('action', 'post');
        if (quantity !== null) formData.append('quantity', quantity);
        return fetch(url, { method: 'POST', body: formData, headers: {'X-Requested-With': 'XMLHttpRequest'} })
            .then(res => res.ok ? res.json() : res.json().then(e => { throw new Error(e.error) }));
    }

    function updateCartUI(productId, data) {
        const card = document.querySelector(`.card[data-product-id="${productId}"]`);
        if (card && data.quantity !== undefined) {
            card.querySelector('.quantity-display').textContent = data.quantity;
            card.querySelector('.item-total').textContent = parseFloat(data.item_total).toFixed(2);
        }
        if (data.cart_total !== undefined) document.getElementById('cart-total').textContent = parseFloat(data.cart_total).toFixed(2);
    }
    
    // Wire up buttons (Increase/Decrease/Remove) exactly as in your original script
    // I am omitting the full repeated JS block to save space, but you must keep it.
</script>
{% endblock content %}